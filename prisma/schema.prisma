generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Cliente {
  id            String     @id @default(cuid())
  name          String
  email         String?    @unique
  phone         String?
  taxId         String?
  address       String?
  contactPerson String?
  status        String     @default("ACTIVE")
  responsibleId String?
  metricoolBrandId String?
  lastActivity  String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  proyectos         Proyecto[]
  credentials       Credential[]
  usuariosAsignados ClienteUsuario[]
  hostings          Hosting[]
  dominios          Dominio[]
  @@map("clientes")
}

model Credential {
  id                 String   @id @default(cuid())
  clienteId          String
  category           String
  platform           String
  url                String?
  username           String
  passwordEncrypted  String
  email              String?
  isEmailAccount     Boolean  @default(false)
  emailProvider      String?
  parentId           String?
  notes              String?
  isActive           Boolean  @default(true)
  createdById        String?
  createdByName      String?
  lastModifiedById   String?
  lastModifiedByName String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  cliente            Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@map("credentials")
}

model ClienteUsuario {
  id        String   @id @default(cuid())
  clienteId String
  usuarioId String
  role      String   @default("MEMBER")
  createdAt DateTime @default(now())

  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([clienteId, usuarioId])
  @@map("clientes_usuarios")
}

model Usuario {
  id                 String     @id @default(cuid())
  name               String
  email              String     @unique
  password           String?
  role               String     @default("DEV")
  position           String?
  avatarUrl          String?
  joinDate           DateTime   @default(now())
  tipoContrato       String     @default("COMPLETA")
  ciudad             String?
  codigoPostal       String?
  direccion          String?
  dni                String?
  fechaNacimiento    DateTime?
  iban               String?
  telefono           String?
  telefonoEmergencia String?
  titularCuenta      String?
  fechaAltaSS        DateTime?
  numSeguridadSocial String?
  tipoContratacion   String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  eventos                                   eventos[]
  jornadas                                  jornadas[]
  timeEntries         TimeEntry[]
  permisos_aprobador                        permisos[] @relation("permisos_aprobadorIdTousuarios")
  permisos_solicitante                      permisos[] @relation("permisos_solicitanteIdTousuarios")
  proyectos                                 Proyecto[]
  tareasAsignadas                           Tarea[]    @relation("TareaAssignee")
  ticketsReceived                           Ticket[]   @relation("TicketRecipient")
  ticketsSent                               Ticket[]   @relation("TicketSender")
  clientesAsignados                         ClienteUsuario[]

  @@map("usuarios")
}

model Proyecto {
  id            String    @id @default(cuid())
  title         String
  clienteId     String
  responsibleId String?
  status        String    @default("ACTIVE")
  budget        Float?
  deadline      DateTime?
  isArchived    Boolean   @default(false)
  tags          String[]  @default([])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  cliente       Cliente   @relation(fields: [clienteId], references: [id])
  responsable   Usuario?  @relation(fields: [responsibleId], references: [id])
  tareas        Tarea[]

  @@map("proyectos")
}

model Tarea {
  id             String      @id @default(cuid())
  title          String
  description    String?
  status         String      @default("PENDING")
  priority       String      @default("MEDIUM")
  type           String      @default("OPERATIONAL")
  proyectoId     String
  assigneeId     String?
  estimatedHours Float?
  dueDate        DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  assignee       Usuario?    @relation("TareaAssignee", fields: [assigneeId], references: [id])
  proyecto       Proyecto    @relation(fields: [proyectoId], references: [id])
  timeEntries    TimeEntry[]

  @@map("tareas")
}

model TimeEntry {
  id          String    @id @default(cuid())
  userId      String
  tareaId     String?
  startTime   DateTime
  endTime     DateTime?
  description String?
  createdAt   DateTime  @default(now())
  
  usuario     Usuario   @relation(fields: [userId], references: [id])
  tarea       Tarea?    @relation(fields: [tareaId], references: [id])
  @@map("time_entries")
}

model Ticket {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("OPEN")
  priority    String   @default("MEDIUM")
  senderId    String
  recipientId String?
  readBy      String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  sender      Usuario  @relation("TicketSender", fields: [senderId], references: [id])
  recipient   Usuario? @relation("TicketRecipient", fields: [recipientId], references: [id])

  @@map("tickets")
}

model categorias_servicio {
  id               String             @id
  codigo           String             @unique
  nombre           String
  descripcion      String?
  color            String             @default("#6B7280")
  icono            String?
  orden            Int                @default(0)
  activo           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  
  plantillas_tarea plantillas_tarea[]
}

model eventos {
  id          String    @id
  title       String
  description String?
  type        String    @default("MEETING")
  startDate   DateTime
  endDate     DateTime?
  startTime   String?
  endTime     String?
  allDay      Boolean   @default(false)
  color       String?
  createdById String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  
  createdBy   Usuario?  @relation(fields: [createdById], references: [id])
}

model jornadas {
  id                   String    @id
  usuarioId            String
  fecha                DateTime  @db.Date
  horaInicio           DateTime
  horaPausaAlmuerzo    DateTime?
  horaReinicioAlmuerzo DateTime?
  horaFin              DateTime?
  totalMinutos         Int?
  estado               String    @default("EN_CURSO")
  createdAt            DateTime  @default(now())
  updatedAt            DateTime
  
  usuario              Usuario   @relation(fields: [usuarioId], references: [id])

  @@unique([usuarioId, fecha])
}

model permisos {
  id                String    @id
  tipo              String
  motivo            String?
  fechaInicio       DateTime
  fechaFin          DateTime
  estado            String    @default("PENDIENTE")
  fechaSolicitud    DateTime  @default(now())
  fechaResolucion   DateTime?
  comentarioAdmin   String?
  solicitanteId     String
  aprobadorId       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  
  aprobador         Usuario?  @relation("permisos_aprobadorIdTousuarios", fields: [aprobadorId], references: [id])
  solicitante       Usuario   @relation("permisos_solicitanteIdTousuarios", fields: [solicitanteId], references: [id])
}

model plantillas_tarea {
  id              String              @id
  codigo          String              @unique
  nombre          String
  descripcion     String?
  categoriaId     String
  rolSugeridoTipo String?
  tiempoEstimado  Float               @default(1)
  esRecurrente    Boolean             @default(false)
  frecuencia      String?
  activo          Boolean             @default(true)
  orden           Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime
  
  categoria       categorias_servicio @relation(fields: [categoriaId], references: [id])
}
// ==========================================
// MÓDULO DE HOSTING Y DOMINIOS
// ==========================================

model Proveedor {
  id          String   @id @default(cuid())
  nombre      String   @unique
  tipo        String   // HOSTING, DOMINIOS, AMBOS
  website     String?
  notas       String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  hostings    Hosting[]
  dominios    Dominio[]

  @@map("proveedores")
}

model Hosting {
  id                  String    @id @default(cuid())
  clienteId           String
  proveedorId         String
  nombre              String    // Nombre identificativo del hosting
  tipoHosting         String    // COMPARTIDO, VPS, DEDICADO, CLOUD, RESELLER
  especificaciones    String?   // RAM, CPU, espacio, etc.
  ipServidor          String?
  panelControl        String?   // cPanel, Plesk, DirectAdmin, etc.
  urlPanel            String?
  usuarioPanel        String?
  passwordPanel       String?
  
  // Facturación
  importeCoste        Float     // Lo que pagamos al proveedor
  importeVenta        Float     // Lo que cobramos al cliente
  periodicidad        String    @default("ANUAL") // MENSUAL, TRIMESTRAL, SEMESTRAL, ANUAL
  
  // Fechas
  fechaContratacion   DateTime
  fechaVencimiento    DateTime
  fechaUltimaRenovacion DateTime?
  
  // Estado
  estado              String    @default("ACTIVO") // ACTIVO, SUSPENDIDO, CANCELADO, PENDIENTE_RENOVACION
  autoRenovar         Boolean   @default(true)
  notificado30Dias    Boolean   @default(false)
  
  notas               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  cliente             Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  proveedor           Proveedor @relation(fields: [proveedorId], references: [id])
  dominios            Dominio[]

  @@map("hostings")
}

model Dominio {
  id                  String    @id @default(cuid())
  clienteId           String
  hostingId           String?   // Puede estar asociado a un hosting o ser independiente
  proveedorId         String
  
  nombre              String    // ejemplo.com
  extension           String    // .com, .es, .net, etc.
  
  // SSL
  tieneSSL            Boolean   @default(false)
  tipoSSL             String?   // LETS_ENCRYPT, COMODO, GEOTRUST, etc.
  fechaVencimientoSSL DateTime?
  
  // DNS
  nameservers         String?   // NS1, NS2 separados por coma
  registroDNS         String?   // Notas sobre configuración DNS
  
  // Facturación
  importeCoste        Float     // Lo que pagamos al proveedor
  importeVenta        Float     // Lo que cobramos al cliente
  periodicidad        String    @default("ANUAL")
  
  // Fechas
  fechaRegistro       DateTime
  fechaVencimiento    DateTime
  fechaUltimaRenovacion DateTime?
  
  // Estado
  estado              String    @default("ACTIVO") // ACTIVO, SUSPENDIDO, TRANSFERIDO, EXPIRADO, PENDIENTE_RENOVACION
  autoRenovar         Boolean   @default(true)
  notificado30Dias    Boolean   @default(false)
  
  notas               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  cliente             Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  hosting             Hosting?  @relation(fields: [hostingId], references: [id])
  proveedor           Proveedor @relation(fields: [proveedorId], references: [id])

  @@map("dominios")
}

model PlanHosting {
  id              String   @id @default(cuid())
  nombre          String
  tipo            String   // HOSTING, DOMINIO
  descripcion     String?
  espacio         String?  // 1GB, 2+16GB, etc.
  emails          Int?     // Número de emails incluidos
  incluyeDominio  Boolean  @default(false)
  precioCoste     Float    // Lo que pagamos al proveedor
  precioSugerido  Float?   // Precio sugerido de venta
  activo          Boolean  @default(true)
  orden           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("planes_hosting")
}
